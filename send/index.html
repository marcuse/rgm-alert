<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RetroGuruMessaging - Send</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <style>
      button {
        padding: 0.5em;
      }

      #btnAlert {
        background: #ff0000;
        color: #ffffff;
      }

      #btnClear {
        background: #00ff00;
        color: #000000;
      }

      section {
        display: flex;
        gap: 0.5em;
        margin: 0.5em;

        button {
          flex-grow: 1;
        }

        input {
          flex-grow: 3;
        }
      }
    </style>
  </head>

  <body>
    <script src="https://cdn.ably.com/lib/ably.min-2.js"></script>
    <script>
      let ably = null;

      async function setup() {
        const apiKey = document.getElementById("api_key");
        connect(apiKey.value);
      }

      async function connect(key) {
        ably = new Ably.Realtime(key);
        ably.connection.once("connected", () => {
          console.log("Connected to Ably!");
          const connect = document.getElementById("connect");
          const main = document.getElementById("main");
          connect.style.display = "none";
          main.style.display = "block";
          localStorage.setItem("apiKey", key);
        });
      }

      async function sendAlert(msg) {
        const channel = ably.channels.get("guru");
        channel.publish("alert", msg, (err) => {
          console.log("doink!");
          if (err) result.innerText = err;
          else {
            result.innerText = "Sent!";
          }
        });
      }

      async function sendCustomAlert() {
        const msg = document.getElementById("msg");
        sendAlert(msg.value);
      }

      async function sendClear() {
        const channel = ably.channels.get("guru");
        channel.publish("clear", "");
      }

      async function sendReload() {
        const channel = ably.channels.get("guru");
        channel.publish("reload", "");
      }

      async function resetAPIKey() {
        localStorage.removeItem("apiKey");
      }

      let key;
      if ((key = localStorage.getItem("apiKey"))) {
        connect(key);
      }
    </script>

    <fieldset id="connect">
      <input id="api_key" name="api_key" type="text" />
      <button onclick="setup()">Connect</button>
    </fieldset>

    <fieldset id="main" style="display: none">
      <section>
        <input id="msg" name="msg" type="text" />
        <button onclick="sendCustomAlert()" id="btnAlert">Alert</button>
      </section>
      <section>
        <button onclick="sendClear()" id="btnClear">Clear</button>
      </section>
      <section>
        <button onclick="sendAlert('Mic Check')">Mic Check</button>
        <button onclick="sendAlert('Echo! Echo. echo...')">Echo</button>
        <button onclick="sendAlert('Break Time!')">Break</button>
      </section>
    </fieldset>

    <div id="result"></div>

    <details>
      <summary>Magic stuff</summary>
      <fieldset>
        <section>
          <button onclick="sendReload()">Reload</button>
          <button onclick="resetAPIKey()">Reset API Key</button>
        </section>
      </fieldset>
    </details>
  </body>
</html>
